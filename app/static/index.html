<!-- app/static/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Voice Agent</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; }
        #status { font-weight: bold; color: gray; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ™ï¸ Barge-In Voice Agent</h1>
    <p id="status">Disconnected</p>
    <button id="startBtn">Start Conversation</button>
    <script>
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        let ws;
        let audioContext;
        let workletNode;
        let inputStream;

        let audioQueue = [];
        let isPlaying = false;
        let currentSource = null;

        startBtn.onclick = async () => {
            status.innerText = "Connecting...";
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            await audioContext.resume();

            ws = new WebSocket(`ws://${location.host}/ws/voice`);
            ws.binaryType = 'arraybuffer';

            ws.onopen = async () => {
                status.innerText = "ğŸŸ¢ Online - Speak now!";
                startBtn.disabled = true;
                await initMicrophone();
            };

            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === "interrupt") {
                            console.log('ğŸ›‘ Interrupt received');
                            stopPlayback();
                        }
                    } catch (e) {}
                } else {
                    enqueueAudio(event.data);
                }
            };

            ws.onclose = () => {
                status.innerText = "ğŸ”´ Disconnected";
                startBtn.disabled = false;
                stopAudio();
            };
        };

        async function initMicrophone() {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    channelCount: 1,
                    sampleRate: 16000,
                    echoCancellation: true,
                    noiseSuppression: true
                }
            });
            inputStream = stream;

            // Load external worklet (clean production way)
            await audioContext.audioWorklet.addModule('/static/voice-processor.js');

            const source = audioContext.createMediaStreamSource(stream);
            workletNode = new AudioWorkletNode(audioContext, 'voice-processor');

            workletNode.port.onmessage = (e) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(e.data.buffer); // Float32Array â†’ ArrayBuffer
                }
            };

            source.connect(workletNode);
            workletNode.connect(audioContext.destination); // remove this line if you don't want local echo
        }

        // enqueueAudio, playNextChunk, stopPlayback, stopAudio functions remain exactly the same as before
        function enqueueAudio(arrayBuffer) {
            audioQueue.push(arrayBuffer);
            if (!isPlaying) playNextChunk();
        }

        function playNextChunk() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }
            isPlaying = true;
            const audioData = audioQueue.shift();

            audioContext.decodeAudioData(audioData, (buffer) => {
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);

                currentSource = source;
                source.onended = () => {
                    currentSource = null;
                    playNextChunk();
                };
                source.start(0);
            }, (e) => {
                console.error("Decode error", e);
                playNextChunk();
            });
        }

        function stopPlayback() {
            audioQueue = [];
            if (currentSource) {
                try { currentSource.stop(); } catch (e) {}
                currentSource = null;
            }
            isPlaying = false;
        }

        function stopAudio() {
            stopPlayback();
            if (workletNode) workletNode.disconnect();
            if (inputStream) inputStream.getTracks().forEach(t => t.stop());
        }
    </script>
</body>
</html>